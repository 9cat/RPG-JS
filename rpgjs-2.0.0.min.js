/*!
 * Role Playing Game JavaScript Library 0.0
 * http://rpgjs.com
 * Dependency : CanvasEngine >= 1.2.1 (http://canvasengine.net)
 *
 * Copyright 2013, WebCreative5, Samuel Ronce
 * Licensed under the MIT.
 *
 * Update : Wed Apr  3 13:52:14 2013
 */
Class.create("RPGJS",{defines:function(a){this.params=a;return this},ready:function(b){var a=this;RPGJS=CE.defines(this.params.canvas).extend([Animation,Input,Spritesheet,Scrolling,Window,Text,Effect]).ready(function(c){global.game_system=Class.New("Game_System");global.game_save=Class.New("Game_Save");CE.getJSON("Data/Database.json",function(d){CE.getJSON("Data/Materials.json",function(e){global.data=d;global.materials=e;global.game_switches=Class.New("Game_Switches");global.game_variables=Class.New("Game_Variables");global.game_selfswitches=Class.New("Game_SelfSwitches");global.game_map=Class.New("Game_Map");global.game_actors=Class.New("Game_Actors");global.game_player=Class.New("Game_Player");a.scene.load(["Scene_Map","Scene_Window","Scene_Title","Scene_Menu","Scene_Load","Scene_Gameover","Scene_Generated"],function(){if(a.params.plugins){a.Plugin.add(a.params.plugins,function(){RPGJS_Core.Plugin.call("Sprite","loadBeforeGame");if(b){b.call(a,c)}})}else{if(b){b.call(a,c)}}},a.params.scene_path)})})})},scene:{call:function(a,b){return RPGJS.Scene.call(a,b)},load:function(a,f,b){var c=0;b=b||"";function e(){c++;if(c==a.length&&f){f()}}for(var d=0;d<a.length;d++){name=a[d];RPGJS_Core.loadScript(b+"core/scene/"+name,function(){e()})}}},loadScript:function(c,b){var a=document.createElement("script");a.type="text/javascript";if(a.readyState){a.onreadystatechange=function(){if(a.readyState=="loaded"||a.readyState=="complete"){a.onreadystatechange=null;b()}}}else{a.onload=b}a.src=c+".js";document.getElementsByTagName("head")[0].appendChild(a)},Plugin:{list:[],add:function(c,g){var b,f,k=this,d=0;if(!(c instanceof Array)){c=[c]}function h(l,t){var q={},r=0;l=l+".js";function s(v,u){r++;q[v]=Class.New(v+"_"+u);q.name=u;if(r==2&&t){q.Game._class_=q.Sprite;q.Sprite._class_=q.Game;q.Sprite.scene=RPGJS.Scene.get("Scene_Map");k.list.push(q);t()}}var m=RPGJS.Materials.getBasePath(l),o=RPGJS.Materials.getFilename(l),n=["",""];function p(w,u,v){return w+"/"+u+"/"+v+"_"+u}if(m){n[0]=p(m,o,"Game");n[1]=p(m,o,"Sprite")}else{n[0]=p("plugins",o,"Game");n[1]=p("plugins",o,"Sprite")}RPGJS_Core.loadScript(n[0],function(){s("Game",o)});RPGJS_Core.loadScript(n[1],function(){s("Sprite",o)})}function a(){d++;if(d==c.length&&g){g()}}for(var e=0;e<c.length;e++){b=c[e];h.call(this,b,a)}},call:function(c,a,e){var d;if(!(e instanceof Array)){e=[e]}for(var b=0;b<this.list.length;b++){d=this.list[b][c];if(d[a]){d[a].apply(d,e)}}}},Path:{tilesets:"Graphics/Tilesets/",windowskins:"Graphics/Windowskins/",autotiles:"Graphics/Autotiles/",characters:"Graphics/Characters/",animations:"Graphics/Animations/",pictures:"Graphics/Pictures/",battlers:"Graphics/Battlers/",icons:"Graphics/Icons/",tiles:"Graphics/Tiles/",faces:"Graphics/Faces/",fonts:"Graphics/fonts/",gameovers:"Graphics/Gameovers/",bgms:"Audio/BGM/",bgss:"Audio/BGS/",mes:"Audio/ME/",ses:"Audio/SE/",getFile:function(c,a,b){var e=this[c]+a,d={};if(b){d[c+"_"+b]=e;return d}else{return e}},get:function(b,c,a){var e={},d;if(!global.materials[b]){throw"[Path.get] "+b+" doesn't exist"}if(!global.materials[b][c]){throw"[Path.get]"+b+" - "+c+" doesn't exist"}d=this[b]+global.materials[b][c];if(a){e[b+"_"+c]=d;return e}else{return d}},isSound:function(a){return a=="bgms"||a=="bgss"||a=="mes"||a=="ses"},loadMaterial:function(b,f,e){var d={},a=this.isSound(b)?"sounds":"images";var c=this.get(b,f);d[b+"_"+f]=c;RPGJS.Materials.load(a,d,e)},load:function(c,a,f,e){var d={},b=this.isSound(c)?"sounds":"images";d[c+"_"+f]=this[c]+a;RPGJS.Materials.load(b,d,e)}}});var RPGJS_Core=Class.New("RPGJS"),RPGJS,RPGJS_Scene,global={};Class.create("Interpreter",{currentCmd:null,tmpCommands:[],indent:0,_conditions:{},isRun:false,event:null,initialize:function(b,a){this.preprogrammedCommands();this.event=b;if(a){this.assignCommands(a)}},preprogrammedCommands:function(){var a={CHANGE_GOLD:"cmdChangeGold",SHOW_TEXT:"cmdShowText",ERASE_EVENT:"cmdErase",TRANSFER_PLAYER:"cmdTransferPlayer",BLINK:"cmdBlink",CALL:"cmdCall",SHOW_ANIMATION:"cmdShowAnimation",MOVE_ROUTE:"cmdMoveRoute",SELF_SWITCH_ON:"cmdSelfSwitches",SELF_SWITCH_OFF:"cmdSelfSwitches",SWITCHES_ON:"cmdSwitches",SWITCHES_OFF:"cmdSwitches",SCREEN_FLASH:"cmdScreenFlash",SCREEN_TONE_COLOR:"cmdScreenColorTone",SCREEN_SHAKE:"cmdScreenShake",VARIABLE:"cmdVariables",SET_EVENT_LOCATION:"cmdSetEventLocation",SCROLL_MAP:"cmdScrollMap",PLAY_BGM:"cmdPlayBGM",PLAY_BGS:"cmdPlayBGS",PLAY_ME:"cmdPlayME",PLAY_SE:"cmdPlaySE",STOP_SE:"cmdStopSE",FADE_OUT_MUSIC:"cmdFadeOutMusic",FADE_OUT_SOUND:"cmdFadeOutSound",RESTORE_MUSIC:"cmdRestoreMusic",MEMORIZE_MUSIC:"cmdMemorizeMusic",CHANGE_ITEMS:"cmdChangeItems",CHANGE_WEAPONS:"cmdChangeItems",CHANGE_ARMORS:"cmdChangeItems",CHANGE_LEVEL:"cmdChangeLevel",CHANGE_EXP:"cmdChangeEXP",CHANGE_STATE:"cmdChangeState",CHANGE_CLASS:"cmdChangeClass",CHANGE_SKILLS:"cmdChangeSkills",CHANGE_NAME:"cmdChangeName",CHANGE_CLASS:"cmdChangeClass",CHANGE_GRAPHIC:"cmdChangeGraphic",CHANGE_EQUIPMENT:"cmdChangeEquipment",CHANGE_PARAMS:"cmdChangeParams",CHANGE_HP:"cmdChangeParamPoints",CHANGE_SP:"cmdChangeParamPoints",RECOVER_ALL:"cmdRecoverAll",SHOW_PICTURE:"cmdShowPicture",MOVE_PICTURE:"cmdMovePicture",ROTATE_PICTURE:"cmdRotatePicture",ERASE_PICTURE:"cmdErasePicture",CHANGE_WINDOWSKIN:"cmdChangeWindowskin",DETECTION_EVENTS:"cmdDetectionEvents",CALL_COMMON_EVENT:"cmdCallCommonEvent",CALL_SYSTEM:"cmdCallSystem",CALL_SAVE:"cmdCallSave",ADD_DYNAMIC_EVENT:"cmdAddDynamicEvent",ADD_DYNAMIC_EVENT_RELATIVE:"cmdAddDynamicEventRelative",WAIT:"cmdWait",SCRIPT:"cmdScript",IF:"cmdIf",ELSE:"cmdElse",ENDIF:"cmdEndif",CHOICES:"cmdChoices",CHOICE:"cmdChoice",ENDCHOICES:"cmdEndChoices"};for(var b in a){Interpreter.addCommand(b,a[b])}},getNextCommand:function(){return this.getCommand(this.getCurrentPos()+1)},getPrevCommand:function(){return this.getCommand(this.getCurrentPos()-1)},getCurrentCommand:function(){return this.getCommand(this.getCurrentPos())},getCurrentPos:function(){if(!this.currentCmd){this.setCurrentPos(0)}return this.currentCmd},setCurrentPos:function(a){this.currentCmd=a},getCommand:function(b){var a=this._command(b);if(a){return{name:a.name,params:a.params}}return false},_command:function(k){var d=this.tmpCommands.length>0?this.tmpCommands[k]:this.commands[k];var b,e,a,h,f,c;if(d){try{f=/^([^:]+)(:(.+))?$/.exec(d);if(f!=null){b=f[1];e=f[3];f=/^([^\(]+)\(([^\)]+)\)$/.exec(b);if(f!=null){c=f[2];b=f[1]}if(/CHOICE_[0-9]+/.test(b)){h=Interpreter.commandFunction.CHOICE}else{h=Interpreter.commandFunction[b]}if(h){if(e){e=e.replace(/'/g,'"');e=e.replace(/&quote;/g,"'");e=JSON.parse(e);return{name:b,id:c,params:e,callback:h}}else{return{name:b,id:c,callback:h}}}else{}}else{throw'"'+d+'" => Invalid command'}}catch(g){if(/ILLEGAL$/.test(g)){g='"'+d+'" => Invalid parameters'}throw g}}return false},assignCommands:function(a){a=a||[];this.commands=a;this.parseCommands()},parseCommands:function(){var c,a,f,b,e;var h={},g={},k=0,l=0;change=false;for(var d=0;d<this.commands.length;d++){c=this.commands[d];f=/(^[^:]+)/.exec(c);if(f!=null){a=f[1];if(a=="IF"){b=CanvasEngine.uniqid();h[k]=b;this._conditions[b]={"if":d};k++;change=true}else{if(a=="ELSE"){b=h[k-1];this._conditions[b]["else"]=d;change=true}else{if(a=="ENDIF"){k--;b=h[k];this._conditions[b]["endif"]=d;change=true}}}if(a=="CHOICES"){b=CanvasEngine.uniqid();g[l]=b;this._conditions[b]={choices:d};l++;change=true}else{if(/CHOICE_[0-9]+/.test(a)){f=/CHOICE_([0-9]+)/.exec(a);b=g[l-1];this._conditions[b]["choice_"+f[1]]=d;change=true}else{if(a=="ENDCHOICES"){l--;b=g[l];this._conditions[b]["endchoices"]=d;change=true}}}if(change){e=a+"("+b+")";this.commands[d]=c.replace(a,e)}change=false}}},execCommands:function(a){if(!this._finish){this._finish=a}var b=this._command(this.getCurrentPos());if(b){var c=this[b.callback].call(this,b.params,b.name,b.id);this.isRun=true}else{this.setCurrentPos(0);this.isRun=false;this.tmpCommands=[];this.currentEvent=null;if(this.event){this.event.finishCommands()}if(this._finish){this._finish.call(this)}}},nextCommand:function(){this.setCurrentPos(this.getCurrentPos()+1);this.execCommands()},commandsExit:function(a){this.currentCmd=-2},cmdShowText:function(g){var a=this;var e=this.getPrevCommand();var c=this.getNextCommand();var f=g.text;var d=/%V\[([0-9]+)\]/g;var b=d.exec(f);while(b!=null){f=f.replace(b[0],global.game_variables.get(b[1]));b=d.exec(f)}if(!this.scene_window){this.scene_window=RPGJS_Core.scene.call("Scene_Window",{overlay:true});this.scene_window.box()}if(c.name!="CHOICES"){this.scene_window.onEnterPress(function(){if(c.name!="SHOW_TEXT"){RPGJS.Scene.exit("Scene_Window");a.scene_window=null}a.nextCommand()})}else{this.nextCommand()}this.scene_window.text(f)},cmdChoice:function(b,a,c){this.setCurrentPos(this._conditions[c]["endchoices"]);this.nextCommand()},cmdChoices:function(f,c,e){var b=[];if(!(f instanceof Array)){for(var d in f){if(f[d]!=""){b.push(f[d])}}f=b}var a=this;if(!this.scene_window){this.scene_window=RPGJS_Core.scene.call("Scene_Window",{overlay:true})}this.scene_window.choices(f);this.scene_window.onEnterPressChoice(function(g){var h=a._conditions[e];a._conditions[e].val=false;a.setCurrentPos(h["choice_"+g]);RPGJS.Scene.exit("Scene_Window");a.scene_window=null;a.nextCommand()})},cmdEndChoices:function(){this.nextCommand()},cmdErase:function(){this.event.remove();this.commandsExit();this.nextCommand()},cmdSwitches:function(b,a){var c=b.id;if(!c){c=b}global.game_switches.set(c,a=="SWITCHES_ON");this.nextCommand()},cmdSelfSwitches:function(a,b){var c=a.id;if(!c){c=a}global.game_selfswitches.set(this.event.map_id,this.event.id,c,b=="SELF_SWITCH_ON");this.nextCommand()},cmdVariables:function(c){var a=c.operand;var b;if(typeof a=="object"){if(a instanceof Array){b=Math.floor(Math.random()*(a[1]-a[0]))+a[0]}else{if(a.variable!==undefined){b=global.game_variables.get(a.variable)}}}else{b=a}global.game_variables.set(c.id,b,c.operation);this.nextCommand()},cmdChangeGold:function(b){var a=this._getValue(b);global.game_player.addGold(a);this.nextCommand()},cmdMoveRoute:function(b){var a=-1,c=self.event;d();function d(){a++;if(b.move[a]!==undefined){switch(b.move[a]){case 2:case 4:case 6:case 8:case"up":case"left":case"right":case"bottom":c.moveOneTile(b.move,function(){d()});break;case"step_backward":c.moveAwayFromPlayer(function(){d()});break}}else{}}},cmdShowAnimation:function(a){if(!a.target){a.target=this.event.id}global.game_map._scene.animation(a.target,a.name);this.nextCommand()},cmdTransferPlayer:function(a){var b={x:a.x,y:a.y,id:a.name};if(a["position-type"]=="constant"){b={x:a.appointement.x,y:a.appointement.y,id:a.appointement.id}}else{if(a["position-type"]=="variables"){b.id=a.appointement.id}}if(a["position-type"]){a.name=b.id}RPGJS_Core.scene.call("Scene_Map",{params:{map_id:b.id,pos:b}});global.game_player.freeze=false},cmdBlink:function(b){var a=this;var c;switch(b.target){case"this":c=this.event.id;break;case"player":c=0;break;default:c=b.target}global.game_map.callScene("blink",[c,b.duration,b.frequence,function(){a.nextCommand()}])},cmdScreenFlash:function(b){var a=this;function c(){a.nextCommand()}var d=[b.color,b.speed],e=null;if(b.wait=="_no"){c()}else{e=c}global.game_map._scene.effect("screenFlash",d,e)},cmdScreenColorTone:function(b){var a=this;function c(){a.nextCommand()}b.composite=b.composite||"darker";var d=[b.color,b.speed,b.composite,b.opacity],e=null;if(b.wait=="_no"){c()}else{e=c}global.game_map._scene.effect("changeScreenColorTone",d,e)},cmdScreenShake:function(b){var a=this;function c(){a.nextCommand()}var d=[b.power[0],b.speed[0],b.duration,b.axis],e=null;if(b.wait=="_no"){c()}else{e=c}global.game_map._scene.effect("shake",d,e)},cmdSetEventLocation:function(d){var c=this._target.call(d.event);var a,e;if(d["position-type"]=="constant"&&d.appointement){a=d.appointement.x;e=d.appointement.y}else{if(d["position-type"]=="variables"){a=global.game_variables.get(d.x);e=global.game_variables.get(d.y)}else{if(d["position-type"]=="other_event"){var b=this._target(d.other_event);a=b.x;e=b.y;b.moveto(c.x,c.y)}}}if(d.direction){c.direction=d.direction}c.moveto(a,e);global.game_map.refreshEvents();this.nextCommand()},cmdScrollMap:function(b){var a=this;var c={x:b.x*global.game_map.tile_w,y:b.x*global.game_map.tile_h,};global.game_map.scrollMap(c,function(){a.nextCommand()})},cmdWait:function(b){var a=this;setTimeout(function(){a.nextCommand()},b.frame*1000/60)},cmdPlayBGM:function(a){global.game_system.bgmPlay(a.id);this.nextCommand()},cmdPlayBGS:function(a){global.game_system.bgsPlay(a.id);this.nextCommand()},cmdPlayME:function(a){global.game_system.mePlay(a.id);this.nextCommand()},cmdPlaySE:function(a){global.game_system.sePlay(a.id);this.nextCommand()},cmdStopSE:function(){global.game_system.seStop();this.nextCommand()},cmdFadeOutMusic:function(a){global.game_system.fadeOutMusic(a.frame);this.nextCommand()},cmdFadeOutSound:function(){global.game_system.fadeOutSound(params.frame);this.nextCommand()},cmdMemorizeMusic:function(){global.game_system.memorizeMusic();this.nextCommand()},cmdRestoreMusic:function(){global.game_system.restoreMusic();this.nextCommand()},cmdChangeItems:function(f,d){var a,c,g,e,b;a=this._getValue(f);switch(d){case"CHANGE_WEAPONS":e="weapons";break;case"CHANGE_ARMORS":e="armors";break;default:e="items"}g=f.id;if(a>=0){global.game_player.addItem(e,g,a)}else{global.game_player.removeItem(e,g,Math.abs(a))}this.nextCommand()},cmdChangeLevel:function(b){var a=this._getValue(b);this._execActor(b,function(c){c.setLevel(a)});this.nextCommand()},cmdChangeEXP:function(b){var a=this._getValue(b);this._execActor(b,function(c){c.addExp(a)});this.nextCommand()},cmdChangeParams:function(b){var a=this._getValue(b,client);this._execActor(b,function(c){c.setParamLevel(b.param,c.currentLevel,a)});this.nextCommand()},cmdChangeParamPoints:function(d,b){var a=this._getValue(d),c;this._execActor(d,function(e){switch(b){case"CHANGE_HP":c="hp";break;case"CHANGE_SP":c="sp";break}e.changeParamPoints(c,a)});this.nextCommand()},cmdRecoverAll:function(c){var b=[["hp","hp_max"],["sp","sp_max"]],a;this._execActor(c,function(e){for(var d=0;d<b.length;d++){a=e.getCurrentParam(b[d][1]);e.changeParamPoints(b[d][0],a)}});this.nextCommand()},cmdChangeSkills:function(a){this._execActor(a,function(b){if(a.operation=="increase"){b.learnSkill(a.skill)}else{b.removeSkill(a.skill)}});this.nextCommand()},cmdChangeName:function(a){this._execActor(a,function(b){b.name=a.name});this.nextCommand()},cmdChangeClass:function(a){this._execActor(a,function(b){b.setClass(a["class"])});this.nextCommand()},cmdChangeGraphic:function(a){global_game_player.graphic=a.graphic;global_game_player.refreshPlayer();this.nextCommand()},cmdChangeEquipment:function(c){var a=c["operand-type"],b;if(a=="weapons"){b="weapons"}else{b="armors"}this._execActor(c,function(d){var e=d.getItemsEquipedByType(b);d.removeItemEquiped(b,e);d.equipItem(b,c.operand)});this.nextCommand()},cmdChangeState:function(a){this._execActor(a,function(b){if(a.operation=="increase"){b.addState(a.state)}else{b.removeState(a.state)}});this.nextCommand()},_valuePicture:function(a){if(a["operand-type"]=="variables"||a.variables){a.x=global_game_variables.get(a.x);a.y=global_game_variables.get(a.y)}return a},cmdShowPicture:function(b){var a=this;b=this._valuePicture(b);global.game_map.callScene("pictures",["add",[b.id,b,function(){a.nextCommand()}]])},cmdMovePicture:function(a){a=this._valuePicture(a);global.game_map.callScene("pictures",["move",[a.id,a.duration,a]]);this.nextCommand()},cmdRotatePicture:function(a){global.game_map.callScene("pictures",["rotate",[a.id,a.speed]]);this.nextCommand()},cmdErasePicture:function(a){global.game_map.callScene("pictures",["erase",[a.id]]);this.nextCommand()},cmdDetectionEvents:function(a){this.event.detectionEvents(a.area*global.game_map.tile_w,a.id);this.nextCommand()},cmdCallCommonEvent:function(b){var a=this;Class.New("Game_CommonEvents",[b.name]).exec(this.event,function(){a.nextCommand()})},cmdAddDynamicEvent:function(a){global.game_map.addDynamicEvent(a.name,{x:a.x,y:a.y})},cmdAddDynamicEventRelative:function(d){var c=global.game_player.direction,m=global.game_map.tile_w,f=global.game_map.tile_h,l=global.game_player.x/m,k=global.game_player.y/f,h,g;if(+d.move){var b=[];for(var e=0;e<d.dir;e++){b.push(c)}global.game_map.addDynamicEvent(d.name,{x:l,y:k},function(o,n){n.moveTilePath(b)})}else{h=l;g=k;var a=d.dir;switch(c){case"left":h=l-a;break;case"right":h=l+a;break;case"up":g=k-a;break;case"bottom":g=k+a;break}global.game_map.addDynamicEvent(d.name,{x:h,y:g})}},cmdCallSystem:function(a){},cmdCallSave:function(){var a=RPGJS_Core.scene.call("Scene_Load");a.refresh("save")},cmdScript:function(a){return a.text},cmdIf:function(params,name,id){var this_event=this.event;if(params.command){params=params.command}function actor(id,method,params){var _actor=global.game_actors.getById(id);if(_actor){if(params=="isParameter"){return _actor[method]}else{if(!(params instanceof Array)){params=[params]}return _actor[method].apply(_actor,params)}}}function event(id){if(id===undefined||id=="NULL"){return this_event}if(id==0){return global.game_player}else{return global.game_map.getEvent(id)}}var _var={"switch[%1]":"global.game_switches.get(%1)","self_switch[%1]":'global.game_selfswitches.get(this_event.map_id, this_event.id, "%1")',"variable[%1]":"global.game_variables.get(%1)","actor_in_party[%1]":"global.game_actors.getById(%1)","actor_name[%1]":'actor(%1, "name", "isParameter")',"actor_skill_learned[%1,%2]":'actor(%1, "getSkill", %2)',"actor_state_inflicted[%1,%2]":'actor(%1, "stateInflicted", %2)',"actor_weapon_equiped[%1,%2]":'actor(%1, "itemIsEquiped", ["weapons", %2])',"actor_armor_equiped[%1,%2]":'actor(%1, "itemIsEquiped", ["armors", %2])',"character_facing[%1]":"event(%1).direction",gold:"global.game_player.gold","item_possessed[%1]":'global.game_player.getItem("items", %1)',"weapon_possessed[%1]":'global.game_player.getItem("weapons", %1)',"armor_possessed[%1]":'global.game_player.getItem("armors", %1)'},patt,new_key,n;for(var key in _var){new_key=key.replace(/\[/g,"\\[");new_key=new_key.replace(/\]/g,"\\]");new_key=new_key.replace(/%[0-9]+/g,"([0-9A-Z]+)");patt=new RegExp(new_key,"gi");n=patt.exec(params);params=params.replace(patt,_var[key]);if(n){for(var i=1;i<=10;i++){if(n[i]){params=params.replace("%"+i,n[i])}}}}var e=eval(params),c;c=this._conditions[id];if(!e){c.val=false;if(c["else"]){this.setCurrentPos(c["else"])}else{this.setCurrentPos(c.endif)}}this.nextCommand()},cmdElse:function(b,a,c){this.setCurrentPos(this._conditions[c]["endif"]);this.nextCommand()},cmdEndif:function(){this.nextCommand()},_nextRealPos:function(){var d=self.currentCmd+1;var b=true;var c,a=self.indent},_execActor:function(c,d){var b=[];if(c.actor==undefined){c.actor=0}if(c.actor=="all"){b=global.game_actors.get()}else{b=[global.game_actors.get(c.actor)]}for(var a=0;a<b.length;a++){if(d){d.call(this,b[a])}}return b},_getValue:function(c){var a,b;if(c.variable||c["operand-type"]=="variables"){b=c.variable||c.operand;a=global.game_variables.get(b)}else{a=c.constant||c.operand}return a*(c.operation=="decrease"?-1:1)},_actor:function(b,a){return a.getDatabase("actors",b)},_target:function(a){if(a=="this"||a===undefined){return this.event}else{if(a=="player"||a==0){return global.game_player}}return global.game_map.getEvent(a)}});Interpreter={};Interpreter.commandFunction={};Interpreter.setCommand=function(b,a){Interpreter.commandFunction[b]=a};Interpreter.addCommand=Interpreter.setCommand;Class.create("Game_Plugin",{_class_:null,callSprite:function(b,a){b="_"+b;if(this._class_&&this._class_[b]){return this._class_[b].apply(this._class_,a)}}});Class.create("Game_System",{_current:{bgm:null,bgs:null,se:null,me:null},_memorize:{bgm:null,bgs:null},bgmPlay:function(a){this._playAudio(a,"bgm")},bgsPlay:function(a){this._playAudio(a,"bgs")},mePlay:function(a){this._playAudio(a,"me")},sePlay:function(a){this._playAudio(a,"se")},seStop:function(){if(!this._current.se){return false}this._stopAudio(this._current.se,"se")},memorizeMusic:function(){this._memorize.bgm=this._current.bgm;this._memorize.bgs=this._current.bgs},restoreMusic:function(){this._stopAudio(this._current.bgm,"bgm");this._stopAudio(this._current.bgs,"bgs");this._playAudio(this._memorize.bgm,"bgm");this._playAudio(this._memorize.bgs,"bgs")},fadeOutMusic:function(b){var a=this;if(this._current.bgm){RPGJS.Sound.fadeOut("bgms_"+this._current.bgm,b,function(){a._stopAudio(a._current.bgm,"bgm")})}if(this._current.bgs){RPGJS.Sound.fadeOut("bgss_"+this._current.bgs,b,function(){a._stopAudio(a._current.bgs,"bgs")})}},fadeOutSound:function(b){var a=this;if(this._current.me){RPGJS.Sound.fadeOut("bgms_"+this._current.me,b,function(){a._stopAudio(a._current.me,"me")})}if(this._current.se){RPGJS.Sound.fadeOut("bgss_"+this._current.se,b,function(){a._stopAudio(a._current.se,"se")})}},_playAudio:function(b,a){this._current[a]=b;RPGJS_Core.Path.loadMaterial(a+"s",b,function(){RPGJS.Sound.get(a+"s_"+b).play()})},_stopAudio:function(b,a){this._current[a]=null;RPGJS.Sound.get(a+"s_"+b).pause()}});Class.create("Game_Switches",{initialize:function(){this.data={}},get:function(a){if(a<=5000&&this.data[a]!=null){return this.data[a]}else{return false}},set:function(b,c){if(!(b instanceof Array)){b=[b]}for(var a=0;a<b.length;a++){this.data[b[a]]=c}global.game_map.refreshEvents()}});Class.create("Game_Variables",{initialize:function(){this.data={}},get:function(a){if(this.data[a]!=null){return this.data[a]}else{return 0}},set:function(c,a,b){if(typeof c=="number"){c=[c]}if(typeof a=="object"){if(a instanceof Array){a=CE.random(a[0],a[1])}else{if(a.variable!==undefined){a=global.game_variables.get(a.variable)}}}for(i=0;i<c.length;i++){_var=this.get(c[i]);switch(b){case"add":_var+=+a;break;case"sub":_var-=a;break;case"mul":_var*=a;break;case"div":_var/=a;break;case"mod":_var%=a;break;default:_var=a}this.data[c[i]]=_var}global.game_map.refreshEvents()}});Class.create("Game_SelfSwitches",{initialize:function(){this.data={}},get:function(a,c,b){if(this.data[a]&&this.data[a][c]){return this.data[a][c][b]}return false},set:function(a,d,b,c){if(!this.data[a]){this.data[a]={}}if(!this.data[a][d]){this.data[a][d]={}}this.data[a][d][b]=c;global.game_map.refreshEvents()}});Class.create("Game_CommonEvents",{initialize:function(a){this.id=a},exec:function(e,d){var b=global.data.common_events[this.id],a;if(typeof e=="function"){d=e;e=false}if(!e){e=global.game_player}if(b){for(var c=0;c<b.commands.length;c++){b.commands[c]=b.commands[c].replace(/&apos;/g,"'")}a=Class.New("Interpreter",[this.event,b.commands]);a.execCommands(d)}}});Class.create("Game_Map",{grid:null,nb_autotiles_max:64,events:{},tile_w:32,tile_h:32,_scene:null,_callback:null,initialize:function(){this.tileset_data=global.data.tilesets;this.actions_data=global.data.actions;this.autotiles_data=global.data.autotiles;this.tick()},transfer_player:function(a,b){global.game_player.moveto(a,b)},load:function(e,f,d){var b=this,c,a=e.map_id;this.events={};if(typeof a=="function"){c=f;f=a;d=c;a=false}if(a){this.map_id=a}else{this.map_id=global.data.system?global.data.system.start.id:0}global.game_player.map_id=this.map_id;if(e.pos){global.game_player.x=e.pos.x;global.game_player.y=e.pos.y}this.map=global.data.map_infos[this.map_id];if(f){this._callback=f}if(d){this._scene=d}CE.getJSON("Data/Maps/MAP-"+this.map_id+".json",function(g){b.map.data=g;b.grid=Class.New("Grid",[g.map.length,g.map[0].length]);b.grid.setCellSize(b.tile_w,b.tile_h);b.grid.setPropertyCell(g.map);b._setup()})},scrollMap:function(a){this.callScene("scrollMap",[a])},passable:function(m,t,s,l,h,B){m.savePosition();m.position(l,h);var D=this.grid.getEntityCells(m),a,v,q,r;var c;var o=this;function C(e){var d,F,y;for(var p=0;p<e.length;p++){d=e[p];if(d[0]!=undefined){F=d[0].sides;var x=(p==0||p==2)&&F!=p,k=(p==1||p==3)&&F!=p;if(B=="left"&&((F==3&&p==1)||x)){return true}else{if(B=="right"&&((F==1&&p==3)||x)){return true}else{if(B=="bottom"&&((F==2&&p==0)||k)){return true}else{if(B=="up"&&((F==0&&p==2)||k)){return true}}}}}}return false}function f(x){var d,F,y=m.getPolygon().points,k=l,e=h;function p(H,I){return{x:H*o.tile_w,y:I*o.tile_h}}if(!(x instanceof Class)){d=[p(x.col,x.row),p(x.col+1,x.row),p(x.col+1,x.row+1),p(x.col,x.row+1)]}else{var G=x.getPolygon().points;d=[{x:x.x+G[0].x,y:x.y+G[0].y},{x:x.x+G[1].x,y:x.y+G[1].y},{x:x.x+G[2].x,y:x.y+G[2].y},{x:x.x+G[3].x,y:x.y+G[3].y}]}switch(B){case"left":F=Math.abs(d[1].x-(t+y[0].x));k=t-F;break;case"right":F=Math.abs(d[0].x-(t+y[1].x));k=t+F;break;case"up":F=Math.abs(d[3].y-(s+y[0].y));e=s-F;break;case"bottom":F=Math.abs(d[0].y-(s+y[2].y));e=s+F;break}return{passable:false,x:k,y:e}}var b=D.cells,u=true,E=true;for(var z=0;z<b.length;z++){a=this.grid.getPropertyByCell(b[z].col,b[z].row);if(!a){m.restorePosition();return{passable:false,x:t,y:s}}var g=1;for(var w=a.length-1;w>=0;w--){if(a[w]||a[w]==0){if(this.isAutotile(a[w])){r=this.getPropAutotile(a[w])}else{r=this.getPropTile(a[w])}if(!r){g&=1}else{g&=!(r[1]!==undefined&&r[1]>0)}}}if(!g){E=C(this.grid.testCell(b[z],m,{ignoreTypeLine:true}));if(!E){m.restorePosition();var n=f.call(this,b[z]);return n}}}var A;for(var q in this.events){A=this.events[q];if(!A.exist||q==m.id){continue}c=m.hit(A);if(c.over>=1){if(!C(c.result.coincident)){A._hit=true;m.restorePosition();if(c.over==1){if(A.trigger=="contact"){A.execTrigger()}else{RPGJS_Core.Plugin.call("Game","eventContact",[A,this])}}if(A.through){return f.call(this,A)}}else{A._hit=false}}else{A._hit=false}}if(m.id!=0){c=m.hit(global.game_player);if(c.over>=1&&!C(c.result.coincident)){RPGJS_Core.Plugin.call("Game","contactPlayer",[m,this]);return{passable:false,x:t,y:s}}}m.restorePosition();return{passable:true,x:l,y:h}},getEvent:function(a){return this.events[a]},execEvent:function(){var a;for(var b in this.events){a=this.events[b];if(a._hit&&a.trigger=="action_button"){RPGJS_Core.Plugin.call("Game","execEvent",[a,this]);a.execTrigger()}}},updateEvents:function(){var a;for(var b in this.events){this.events[b].update()}},refreshEvents:function(){var a;for(var b in this.events){a=this.events[b].refresh();this._scene.refreshEvent(b,a)}},refreshPlayer:function(){var a=global_game_player.serialize();this.callScene("refreshEvent",[0,a])},getEvent:function(a){return this.events[a]},isAutotile:function(a){return a<this.nb_autotiles_max*48},getPropAutotile:function(b){var a=Math.floor(b/48);return this._autotiles[a]},getPropTile:function(b){var a=b-this.nb_autotiles_max*48;return this._priorities[a]},_setup:function(){if(!this.map.events){this.map.events=[]}var g,b=0,f=this.map.events.length,d=this.map.dynamic_event.length+f,l=this,a=this.tileset_data[this.map.tileset_id],h=this.autotiles_data[this.map.autotiles_id],k=[],n=[];this._tileset_name=a.name;this._priorities=a.propreties;this._autotiles=h?h.propreties:{};function m(o,e){b++;if(e){k.push(e.serialize());if(b!=d){return}}l._callback({data:l.map.data,propreties:l._priorities,musics:{bgm:l.map.bgm,bgs:l.map.bgs},graphics:{tileset:a.graphic,autotiles:h?h.autotiles:{},},autotiles:l._autotiles,player:global.game_player.serialize(),events:k,actions:l.actionSerialize()})}for(var c=0;c<f;c++){g=this.map.events[c];this.loadEvent(g,m)}for(var c=0;c<this.map.dynamic_event.length;c++){g=this.map.dynamic_event[c];this.addDynamicEvent(g.name,g,m,{refresh:false})}if(d==0){m()}global.game_player.start();RPGJS_Core.Plugin.call("Game","loadMap",[this])},getSize:function(){return this.grid.getNbCell()*this.tile_w*this.tile_h},getTileSize:function(){return{width:this.tile_w,height:this.tile_h,}},tileToPixel:function(a,b){return{x:a*this.tile_w,y:b*this.tile_h}},loadEvent:function(b,d,e){var a=this;if(typeof d=="function"){e=d;d=false}var c="Data/Events/"+(!d?"MAP-"+this.map_id+"/":"")+b+".json";CE.getJSON(c,function(f){var g=f[0].id;if(d){g=f[0].id=CanvasEngine.uniqid()}a.events[g]=Class.New("Game_Event",[a.map_id,f]);RPGJS_Core.Plugin.call("Game","addEvent",[a.events[g],a.map_id,f,d,this]);if(e){e.call(this,g,a.events[g],f)}})},addDynamicEvent:function(b,e,d,c){var a=this;c=c||{};this.loadEvent(b,true,function(g,f){f.moveto(e.x,e.y,c);if(c.add){a.callScene("addEvent",[f.serialize()])}if(d){d.call(this,g,f)}})},removeEvent:function(a){this.callScene("removeEvent",[a]);delete this.events[a]},callScene:function(b,a){this._scene[b].apply(this._scene,a)},actionSerialize:function(){var e={},b,d={keypress:"",animation_up:"",animation_bottom:"",animation_right:"",animation_left:"",graphic:"",speed:""};for(var f in this.actions_data){b=this.actions_data[f];e[f]={};for(var c in b){if(c in d){e[f][c]=b[c]}}}return e},execAction:function(a){RPGJS_Core.Plugin.call("Game","action",[this.actions_data[a],a,this])},tick:function(){var b=this;var a=setInterval(function(){RPGJS_Core.Plugin.call("Game","tick",[b])},1000/60)}}).attr_accessor(["tileset_name","autotile_names","panorama_name"]).attr_reader(["map_id","priorities","passages"]);Class.create("Game_Character",{entity:null,_z:null,exp:[],exist:true,currentLevel:1,maxLevel:99,currentExp:0,skillsByLevel:[],params:{},itemEquiped:{},className:"",states:{},skills:[],defstates:{},hp:0,sp:0,items:{},paramPoints:{},typeMove:[],removeMove:{},timeMove:{},initialize:function(){this.id=0;this.position(0,0);this.rect(4,16,32-8,16);if(this._initialize){this._initialize.apply(this,arguments)}},setProperties:function(b){b=b||{};if(b.options){for(var a=0;a<b.options.length;a++){b[b.options[a]]=true}}this.trigger=b.trigger;this.direction_fix=b.direction_fix;this.no_animation=b.no_animation;this.stop_animation=b.stop_animation;this.speed=b.speed===undefined?3:b.speed;this.type=b.type||"fixed";this.frequence=(b.frequence||0)*5;this.nbSequenceX=b.nbSequenceX||4;this.nbSequenceY=b.nbSequenceY||4;this.speedAnimation=b.speedAnimation||5;this.graphic_pattern=b.pattern===undefined?0:b.pattern;this.through=!b.graphic?b.through:true;this.alwaysOnTop=b.alwaysOnTop!==undefined?b.alwaysOnTop:false;this.alwaysOnBottom=b.alwaysOnBottom!==undefined?b.alwaysOnBottom:false;this.regX=b.regX!==undefined?b.regX:0;this.regY=b.regY!==undefined?b.regY:0;if(this.alwaysOnBottom){this._z=0}if(this.alwaysOnTop){this._z=global.game_map.getSize()+1}this.direction=b.direction||"bottom";this.graphic=b.graphic;this.graphic_params=b.graphic_params;switch(this.type){case"random":this.moveRandom();break;case"approach":this.approachPlayer();break}},moveto:function(a,d,b){b=b||{};if(b.tileToPixel===undefined){b.tileToPixel=true}var c=b.tileToPixel?global.game_map.tileToPixel(a,d):{x:a,y:d};this.position(c.x,c.y);if(b.refresh){global.game_map.callScene("setEventPosition",[this.id,c.x,c.y])}},lastTypeMove:function(){return this.typeMove[this.typeMove.length-1]},removeTypeMove:function(b){for(var a=0;a<this.typeMove.length;a++){if(this.typeMove[a]==b){this.removeTypeMove[b]=true;delete this.typeMove[a]}}},approachPlayer:function(){var a=this;this.typeMove.push("approach");b();function b(){if(a.removeTypeMove.approach){a.removeTypeMove.approach=false;return}if(!global.game_map.getEvent(a.id)){return}var c=a.directionRelativeToPlayer();if(c){if(a.lastTypeMove!="approach"){a.moveOneTile(c,function(){if(a.frequence!=0){global.game_map._scene.stopEvent(a.id)}setTimeout(b,a.frequence*60)})}else{setTimeout(b,a.frequence*60)}}}},moveAwayFromPlayer:function(c){var a;var b=global.game_player;if(b){if(b.y<this.y){a="bottom"}else{if(b.y>this.y){a="up"}else{if(b.x>this.x){a="left"}else{if(b.x<this.x){a="right"}}}}this.moveOneTile(a,c)}},directionRelativeToPlayer:function(){var a=global.game_player;if(!a){return false}function c(){if(a.x>this.x){return"right"}if(a.x<this.x){return"left"}}function b(){if(a.y<this.y){return"up"}if(a.y>this.y){return"bottom"}}if(Math.abs(a.x-this.x)<Math.abs(a.y-this.y)){return b.call(this)}else{return c.call(this)}},moveRandom:function(){var a=this;this.typeMove.push("random");b();function b(){if(a.removeTypeMove.random){a.removeTypeMove.random=false;return}if(!global.game_map.getEvent(a.id)){return}var d=CE.random(0,3),c;switch(d){case 0:c="left";break;case 1:c="right";break;case 2:c="up";break;case 3:c="bottom";break}if(a.lastTypeMove!="random"){a.moveOneTile(c,function(){if(a.frequence!=0){global.game_map._scene.stopEvent(a.id)}setTimeout(b,a.frequence*60)})}else{setTimeout(b,a.frequence*60)}}},moveTilePath:function(a){var b=this,c=0;d();function d(){var e=a[c];if(!e){return}b.moveOneTile(e,function(){if(b.frequence!=0){global.game_map._scene.stopEvent(b.id)}c++;setTimeout(d,b.frequence*60)})}},moveOneTile:function(d,h){var g=global.game_map.tile_w/this.speed,e=0,c=this,f=this.frequence;var b=setInterval(function a(){if(!global.game_map.getEvent(c.id)){return}c.moveDir(d);e++;if(e>=g){clearInterval(b);if(h){h.call(this)}}},1000/60)},moveDir:function(b,e){var f;if(this.id==0&&this.freeze){return{x:this.x,y:this.y}}var d=this.speed,a=0,h=0,g;this.direction=b;switch(b){case"left":a=-d;break;case"right":a=d;break;case"up":h=-d;break;case"bottom":h=d;break}var c=global.game_map.passable(this,this.x,this.y,a+this.x,h+this.y,b);if(c.passable||this.alwaysOnTop){f=true}else{f=false}g=this.position(c.x,c.y);global.game_map.callScene("moveEvent",[this.id,g,b]);if(e){return{pos:g,passable:f}}return g},detectionEvents:function(c,a){var b=global.game_map.events;var d=[];for(var e in b){ev=b[e];if(ev.x<=this.x+c&&ev.x>=this.x-c&&ev.y<=this.y+c&&ev.y>=this.y-c&&ev.id!=this.id){global.game_selfswitches.set(ev.map_id,ev.id,a,true);d.push(ev)}}RPGJS_Core.Plugin.call("Game","eventDetected",[d,this]);return d},jumpa:function(a,h,e,g){var b,d,c,f;if(a!=0||h!=0){if(Math.abs(a)>Math.abs(h)){a<0?b="left":b="right"}else{h<0?b="up":b="down"}}d=this.x+a;c=this.y+h;if((a==0&&h==0)||global.game_map.passable(this,this.x,this.y,d,c,b)){this.position(d,c);console.log(d,c);this.removeTypeMove("approach");this.removeTypeMove("random");global.game_map.callScene("jumpEvent",[this.id,a,h,e,g])}},serialize:function(){var b=["id","x","y","nbSequenceX","nbSequenceY","speedAnimation","graphic_pattern","graphic","graphic_params","direction","direction_fix","no_animation","stop_animation","frequence","speed","regX","regY","alwaysOnBottom","alwaysOnTop","exist"];var c={};for(var a=0;a<b.length;a++){c[b[a]]=this[b[a]]}RPGJS_Core.Plugin.call("Game","serializeCharacter",[c,this]);return c},makeExpList:function(e,d,a){a=a||this.maxLevel;if(e instanceof Array){this.exp=e}else{this.exp[0]=this.exp[1]=0;var b=2.4+d/100;var f;for(var c=2;c<=a;c++){f=e*(Math.pow((c+3),b))/(Math.pow(5,b));this.exp[c]=this.exp[c-1]+parseInt(f)}}return this.exp},addExp:function(a){return this.setExp(this.currentExp+a)},setExp:function(e){if(this.exp.length==0){throw"makeExpList() must be called before setExp()";return false}var d;var c=this.currentLevel;this.currentExp=e;for(var b=0;b<this.exp.length;b++){if(this.exp[b]>e){d=b-1;break}}if(!d){d=this.maxLevel;this.currentExp=this.exp[this.exp.length-1]}this.currentLevel=d;var a=d-c;if(a!=0){this._changeSkills()}return a},setLevel:function(b){var a=this.currentLevel;this.currentLevel=b;if(this.exp.length>0){this.currentExp=this.exp[b]}this._changeSkills();return b-a},nextExp:function(){return this.exp[+this.currentLevel+1]},_changeSkills:function(){var b;for(var a=0;a<=this.currentLevel;a++){b=this.skillsByLevel[a];if(b){this.learnSkill(b)}}},setParam:function(a,c,e,f){if(!this.params[a]){this.params[a]=[0]}if(c instanceof Array){this.params[a]=c}else{var d;if(f=="proportional"){d=(e-c)/(this.maxLevel-1)}for(var b=1;b<=this.maxLevel;b++){this.params[a][b]=Math.ceil(c+(b-1)*d)}this.params[a].push(e)}return this.params[a]},getCurrentParam:function(a){if(!a){return this.params}if(!this.params[a]){throw"getCurrentParam - parameter "+a+" doesn't exist"}return this.params[a][this.currentLevel]},setParamLevel:function(a,c,b){if(!this.params[a]){throw"setParamLevel - parameter "+a+" doesn't exist"}if(this.params[a][c]){this.params[a][c]=b}},addCurrentParam:function(a,b,d){var c=this.getCurrentParam(a);if(this.params[a][d]){this.params[a][this.currentLevel]=c+b}},initParamPoints:function(c,e,b,a,d){this.paramPoints[c]={current:e,min:b,max:a,callbacks:d||{}}},getParamPoint:function(a){if(!this.paramPoints[a]){throw"Call the 'initParamPoints' before"}return this.paramPoints[a].current},getAllParamsPoint:function(){return this.paramPoints},changeParamPoints:function(e,b,c){c=c||"add";if(!this.paramPoints[e]){throw"Call the 'initParamPoints' before"}var g=this.paramPoints[e].current,a=this.paramPoints[e].max,d=this.paramPoints[e].min,f=this.paramPoints[e].callbacks;if(typeof a==="string"){a=this.getCurrentParam(a)}if(/%$/.test(b)){g=g+(g*parseInt(b)/100)}else{if(c=="add"){g+=+b}else{if(c=="sub"){g-=+b}else{g=+b}}}if(g<=d){g=d;if(f.onMin){f.onMin.call(this)}}else{if(g>=a){g=a;if(f.onMax){f.onMax.call(this)}}}this.paramPoints[e].current=g;RPGJS_Core.Plugin.call("Game","changeParamPoints",[e,b,c,this]);return g},equipItem:function(a,d){var b=this.removeItem(a,d);if(!b){return false}if(!this.itemEquiped[a]){this.itemEquiped[a]=[]}var c=global.data[a][d];if(!c){return}if(c.atk){this.changeParamPoints("atk",c.atk)}if(c.pdef){this.changeParamPoints("pdef",c.pdef)}if(c.mdef){this.changeParamPoints("mdef",c.mdef)}this.itemEquiped[a].push(d);c=global.data[a][d];this._setState(c.states)},itemIsEquiped:function(b,a){if(this.itemEquiped[b][a]){return true}else{return false}},removeItemEquiped:function(b,d){if(!this.itemEquiped[b]){return false}var c=global.data[b][d],a;if(!c){return}if(c.atk){this.changeParamPoints("atk",-c.atk)}if(c.pdef){this.changeParamPoints("pdef",-c.pdef)}if(c.mdef){this.changeParamPoints("mdef",-c.mdef)}a=this.getIndexEquipedById(b,d);if(a!==false){this.addItem(b,d);delete this.itemEquiped[b][a]}return true},getItemsEquipedByType:function(a){if(!this.itemEquiped[a]){return false}return this.itemEquiped[a]},getIndexEquipedById:function(b,c){if(!this.itemEquiped[b]){return false}for(var a=0;a<this.itemEquiped[b].length;a++){if(this.itemEquiped[b][a]==c){return a}}return false},getItemsEquipedByAttr:function(c,a,e){var f;if(!this.itemEquiped[c]){return false}var d=global.data[c];if(!d){return false}for(var b=0;b<this.itemEquiped[c].length;b++){f=this.itemEquiped[c][b];if(d[f]&&d[f][a]==e){return f}}return false},skillsToLearn:function(a){this.skillsByLevel=a},setSkillToLearn:function(b,a){this.skillsByLevel[b]=a},setClass:function(b){var a=global.data.classes[b];this.className=a.name;this.classId=b;if(a){if(a.skills){this.skillsToLearn(a.skills)}if(a.elements){this.setElements(a._elements)}if(a.states){this.setDefStates(a.states)}}},setElements:function(b){var c={};if(b instanceof Array){for(var a=0;a<b.length;a++){c[b[a][0]]=b[a][1]}}else{c=b}this.elements=c},getElement:function(a){return this.elements[a]},setDefStates:function(a){var c={};for(var b=0;b<a.length;b++){c[a[b][0]]=a[b][1]}this.defstates=c},learnSkill:function(d){var a,c;if(!(d instanceof Array)){d=[d]}for(var b=0;b<d.length;b++){a=this.getSkill(d[b]);if(!a){this.skills.push(d[b]);c=global.data.skills[d];this._setState(c.states)}}},removeSkill:function(a){delete this.getSkill(a)},getSkill:function(b){if(!b){return this.skills}for(var a=0;a<this.skills.length;a++){if(this.skills[a]==b){return this.skills[a]}}return false},addState:function(f){var b,a,d=1;if(this.defstates[f]){switch(this.defstates[f]){case -100:d=1;break;case 0:d=1.2;break;case 50:d=1.5;break;case 100:d=2;break;case 150:d=10;break;case 200:d=20;break}b=CanvasEngine.random(0,100);a=CanvasEngine.random(0,Math.round(100/d));if(b<=a){return false}}var e={},c;e.duringTime=0;this.states[f]=e;c=global.data.states[f];if(c.on_start){Class.New("Game_CommonEvents",[c.on_start]).exec()}if(c.on_during){this.states[f].interval=setInterval(function(){Class.New("Game_CommonEvents",[c.on_during]).exec()},3000)}this.states[f];this._setState(c.states);return true},removeState:function(b){if(!this.states[b]){return false}var a=global.data.states[b];if(a.on_release){Class.New("Game_CommonEvents",[a.on_release]).exec()}if(this.states[b].interval){clearInterval(this.states[b].interval)}delete this.states[b]},_setState:function(c){var b;for(var a=0;a<c.length;a++){b=c[a];if(+b[1]==-1){this.removeState(b[0])}else{if(+b[1]==1){this.addState(b[0])}}}},stateInflicted:function(a){return this.states[a]},addItem:function(b,d,a){if(+d==0){return false}if(!a){a=1}if(!this.items[b]){this.items[b]={}}if(!this.items[b][d]){this.items[b][d]=0}this.items[b][d]+=a;var c=global.data.items[d];this._setState(c.states)},removeItem:function(b,c,a){if(!a){a=1}if(!this.items[b][c]){return false}this.items[b][c]-=a;if(this.items[b][c]<=0){delete this.items[b][c]}return true},useItem:function(a,c){var b=global.data[a][c];if(b&&+b.consumable){if(b.hit_rate){this.changeParamPoints("hp",b.recvr_hp_pourcent+"%");this.changeParamPoints("hp",b.recvr_hp);this.changeParamPoints("sp",b.recvr_sp_pourcent+"%");this.changeParamPoints("sp",b.recvr_sp);if(b.parameter!="0"){this.addCurrentParam(b.parameter,b.parameter_inc)}this.removeItem(a,c);return true}return false}},getItem:function(a,b){return this.items[a][b]?this.items[a][b]:false},getItems:function(a){if(a){return this.items[a]}return this.items},}).attr_reader(["x","y","real_x","real_y","character_name","direction"]).extend("EntityModel");Class.create("Game_Player",{freeze:false,gold:0,step:0,time:0,map_id:0,_initialize:function(){var b=global.data.system?global.data.system:{start:{x:0,y:0,id:1},actor:1},a=global.data.actors[b.actor];this.x=b.start.x;this.y=b.start.y;this.setProperties({graphic:a.graphic,graphic_params:a["graphic-params"]});global.game_actors.add(b.actor,this);this.startTime()},start:function(){this.moveto(this.x,this.y)},startTime:function(){var a=this;setInterval(function(){a.time++},1000)},addGold:function(a){this.gold+=+a;if(this.gold<0){this.gold=0}}}).attr_reader([]).extend("Game_Character");Class.create("Game_Event",{currentPage:-1,_initialize:function(a,c){this.map_id=a;this.pages=c[1];for(var b in c[0]){this[b]=c[0][b]}this.moveto(this.x,this.y);this.interpreter=Class.New("Interpreter",[this]);this.refresh()},refresh:function(){this.setPage();if(this.currentPage==-1){this.exist=false}else{this.exist=true;var a=this.pages[this.currentPage];this.setProperties(a);this.interpreter.assignCommands(a.commands);if(this.trigger=="auto_one_time"){this.execTrigger()}}return this.serialize()},update:function(){if((this.trigger=="auto"||this.trigger=="parallel_process")&&!this.interpreter.isRun){this.execTrigger()}},setPage:function(){var f=false;for(var d=this.pages.length-1;d>=0;d--){if(!f){if(!this.pages[d].conditions){this.currentPage=d;f=true}else{var e=true;var g=this.pages[d].conditions;for(var b=1;b<=3;b++){if(g["switch_"+b]!==undefined&&g["switch_"+b]!="0"){e&=global.game_switches.get(g["switch_"+b])}}if(g.self_switch!==undefined&&g.self_switch!="0"){e&=global.game_selfswitches.get(this.map_id,this.id,g.self_switch)}if(g.variable!==undefined&&g.variable!="0"){var c=global.game_variables.get(g.variables);var a=g.variable_value;e&=c>=a}if(e){this.currentPage=d;f=true}}}}return f},execTrigger:function(){if(this.trigger=="action_button"){this.directionRelativeToPlayer()}else{if(this.trigger=="auto"){global.game_player.freeze=true}}this.execCommands()},execCommands:function(){global.game_player.freeze=true;this.old_direction=this.direction;this.direction=this.directionRelativeToPlayer();global.game_map.callScene("refreshEvent",[this.id,this.serialize()]);this.interpreter.execCommands()},finishCommands:function(){global.game_player.freeze=false;this.direction=this.old_direction;global.game_map.callScene("refreshEvent",[this.id,this.serialize()])},remove:function(){global.game_map.removeEvent(this.id)},detectionPlayer:function(b){var a=global.game_player;if(a.x<=this.x+b&&a.x>=this.x-b&&a.y<=this.y+b&&a.y>=this.y-b){return true}return false},}).attr_reader(["trigger","list","starting"]).extend("Game_Character");Class.create("Game_Actors",{actors:[],add:function(g,b){var f=global.data.actors[g],a=global.data.classes[f["class"]];b.name=f.name;b._id=g;b.maxLevel=f.level_max;if(f.params.exp){b.makeExpList(f.params.exp)}else{b.makeExpList(25,30)}var e={maxhp:[741,7467],maxsp:[534,5500],str:[67,635],dex:[54,564],agi:[58,582],"int":[36,349]};CE.each(["maxhp","maxsp","str","dex","agi","int"],function(h,k){if(f.params[k]){b.setParam(k,f.params[k])}else{b.setParam(k,e[k][0],e[k][1],"proportional")}});b.setClass(f["class"]);b.setLevel(f.level_min);var d=b.getCurrentParam("maxhp");b.initParamPoints("hp",d,0,d);var c=b.getCurrentParam("maxsp");b.initParamPoints("sp",c,0,c);b.initParamPoints("atk",0,0,99999);b.initParamPoints("pdef",0,0,99999);b.initParamPoints("mdef",0,0,99999);b.addItem("weapons",f.weapon);b.addItem("armors",f.shield);b.addItem("armors",f.helmet);b.addItem("armors",f.body_armor);b.addItem("armors",f.accessory);b.equipItem("weapons",f.weapon);b.equipItem("armors",f.shield);b.equipItem("armors",f.helmet);b.equipItem("armors",f.body_armor);b.equipItem("armors",f.accessory);this.actors.push(b)},get:function(a){if(a==undefined){return this.actors}return this.actors[a]},getById:function(b){for(var a=0;a<this.actors.length;a++){if(this.actors[a]._id==b){return this.actors[a]}}return false}});Class.create("Game_Save",{data:[],set:function(a,b){this.data[a]=b},get:function(a){return this.data[a]}});Class.create("Sprite",{showAnimation:function(e){var d=global.data.animations[e];if(!d){return}var b=192,a=192;var c=RPGJS.Animation.New({images:"animations_"+d.graphic,addIn:this.entity.el,animations:{_default:{position:{top:-b/2,left:-a/2},frames:d.frames,size:{width:b,height:a}}}});c.play("_default","remove")}});Class.create("Sprite_Plugin",{_class_:null,callModel:function(b,a){b="_"+b;if(this._class_&&this._class_[b]){return this._class_[b].apply(this._class_,a)}}});Class.create("Spriteset_Map",{stage:null,scene:null,data:null,tile_w:32,tile_h:32,width:0,height:0,nb_layer:3,nb_autotiles_max:64,autotiles:[],events:{},layer:[],picture_layer:null,map:null,pictures:{},initialize:function(d,b,c,e){var a=this;this.scene=d;this.stage=b;this.data=c;this.params=e;this.map=this.scene.createElement();this.nb_layer=this.nb_layer*2+1;CE.each(this.nb_layer,function(f){a.layer[f]=d.createElement();a.map.append(a.layer[f])});this.picture_layer=this.scene.createElement();this.stage.append(this.map,this.picture_layer);this.tilemap({})},tilemap:function(n){RPGJS_Core.Plugin.call("Sprite","drawMapBegin",[this]);var p=this,c=[];function a(v,u,s){var t,A,z;var w=p.tile_h/2;var r=s/w;var q=document.createElement("canvas");var B=q.getContext("2d"),h;for(t=0;t<4;t++){A=0,z=0;h=v.getImageData(u[t][0]*16,u[t][1]*16,w,w);switch(t){case 1:A=w;break;case 2:A=w;z=w;break;case 3:z=w;break}B.putImageData(h,A,z)}c.push(q)}function e(h,s){var q=0;h=(h-1)*2;s=(s-1)*2;var r=[];for(q=0;q<4;q++){switch(q){case 1:h++;break;case 2:s++;break;case 3:h--;break}r.push([h,s])}return r}function d(D,u,w,r){var t,s,q;switch(D){case 0:a(u,w.center,r);break;case 1:var v=[];var B=[];var x;for(t=1;t<=4;t++){for(s=0;s<=v.length;s++){B.push((s!=0?v[s-1]:"")+t+";")}for(s=0;s<B.length;s++){v.push(B[s]);x=B[s].split(";");x.pop();var A=[];for(q=1;q<=4;q++){if(CE.inArray(q,x)!=-1){A.push(w.corner[q-1])}else{A.push(w.center[q-1])}}a(u,A,r)}B=[]}break;case 2:var h=[w.left,w.top,w.right,w.bottom];var C;var z=[2,3];var y;for(t=0;t<4;t++){for(s=0;s<4;s++){C=CE.clone(h[t]);if(s==1||s==3){y=z[0]-1;C[y]=w.corner[y]}if(s==2||s==3){y=z[1]-1;C[y]=w.corner[y]}a(u,C,r)}z[0]++;z[1]++;if(z[0]>4){z[0]=1}if(z[1]>4){z[1]=1}}break;case 3:a(u,[w.left[0],w.right[1],w.right[2],w.left[3]],r);a(u,[w.top[0],w.top[1],w.bottom[2],w.bottom[3]],r);break;case 4:var h=[w.top_left,w.top_right,w.bottom_right,w.bottom_left];var C;var y=3;for(t=0;t<h.length;t++){for(s=0;s<2;s++){C=CE.clone(h[t]);if(s==1){C[y-1]=w.corner[y-1]}a(u,C,r)}y++;if(y>4){y=1}}break;case 5:var h=[[w.top_left[0],w.top_right[1],w.right[2],w.left[3]],[w.top_left[0],w.top[1],w.bottom[2],w.bottom_left[3]],[w.left[0],w.right[1],w.bottom_right[2],w.bottom_left[3]],[w.top[0],w.top_right[1],w.bottom_right[2],w.bottom[3]]];for(t=0;t<h.length;t++){a(u,h[t],r)}break;case 6:a(u,w.full,r);a(u,w.full,r);break}}if(this.params.autotiles){var k={center:e(2,3),full:e(1,1),corner:e(3,1),left:e(1,3),right:e(3,3),top:e(2,2),bottom:e(2,4),top_left:e(1,2),top_right:e(3,2),bottom_left:e(1,4),bottom_right:e(3,4)};CE.each(this.params.autotiles,function(r,t){var q=document.createElement("canvas");var h=q.getContext("2d");var s=RPGJS.Materials.images[t];q.width=s.width;q.height=s.height;h.drawImage(s,0,0);for(j=0;j<7;j++){d(j,h,k,false)}})}var l=this.data.data.map,m=this.data.autotiles,f=this.data.propreties,b;this.width=l.length;this.height=l[0].length;CE.benchmark("draw map");CE.each(l,function(q,h){CE.each(l[q],function(r,s){CE.each(l[q][r],function(u,x){if(l[q][r][u]===undefined||l[q][r][u]==null){return}var w=p.scene.createElement();if(p.nb_autotiles_max*48<=x){x-=(p.nb_autotiles_max*48);var t=parseInt(x/(256/p.tile_h))*p.tile_h;var v=(x%(256/p.tile_w))*p.tile_w;w.drawImage("tileset",v,t,p.tile_w,p.tile_h,0,0,p.tile_w,p.tile_h);b=f[x]}else{w.drawImage(c[x]);b=m[Math.floor(x/48)]}w.x=q*p.tile_w;w.y=r*p.tile_h;if(!b){b=[0,0]}if(b.length==0){b=[0,0]}p.layer[((b[0]>0?1:0)*4)].append(w)})})});var o=this.getWidthPixel(),g=this.getHeightPixel();this.layer[0].pack(o,g);this.layer[4].pack(o,g);RPGJS_Core.Plugin.call("Sprite","drawMapEnd",[this]);this.characters(this.layer[3])},characters:function(c){var d,b;for(var a=0;a<this.data.events.length;a++){d=this.data.events[a];this.addCharacter(d)}this.player=Class.New("Sprite_Character",[this.scene,this.data.player,c,global.game_player]);this.player.initAnimationActions(this.data.actions);this.scrolling=RPGJS.Scrolling.New(this.scene,this.tile_w,this.tile_h);this.scrolling.setMainElement(this.player.getSprite());this.scrolling.addScroll({element:this.map,speed:global.game_player.speed,block:true,width:this.getWidthPixel(),height:this.getHeightPixel()});RPGJS_Core.Plugin.call("Sprite","drawCharactersEnd",[this])},addCharacter:function(b){var a=Class.New("Sprite_Character",[this.scene,b,this.layer[3],global.game_map.getEvent(b.id)]);this.events[b.id]=a;RPGJS_Core.Plugin.call("Sprite","addCharacter",[a,b,this])},addPicture:function(d,c,b){var a=this;c.opacity=c.opacity||255;c.zoom_x=c.zoom_x||100;c.zoom_y=c.zoom_y||100;RPGJS_Core.Path.load("pictures",c.filename,d,function(e){var f=a.scene.createElement();f.drawImage("pictures_"+d);f.x=c.x;f.y=c.y;f.width=e.width;f.height=e.height;if(c.origin=="center"){f.setPositionOrigin("middle")}f.scaleX=c.zoom_x/100;f.scaleY=c.zoom_y/100;f.opacity=c.opacity/255;a.picture_layer.append(f);a.pictures[d]=f;if(b){b()}})},movePicture:function(f,d,e,b){var c=this.pictures[f];if(!c){return false}if(e.origin=="center"){c.setPositionOrigin("middle")}var a=RPGJS.Timeline.New(c);e.opacity=e.opacity||255;e.zoom_x=e.zoom_x||100;e.zoom_y=e.zoom_y||100;a.to({x:e.x,y:e.y,opacity:e.opacity/255,scaleX:e.zoom_x/100,scaleY:e.zoom_y/100},d).call(b)},rotatePicture:function(d,c){var b=this.pictures[d];if(!b){return false}var a=RPGJS.Timeline.New(b);a.to({rotation:360},c).loop()},erasePicture:function(b){var a=this.pictures[b];if(!a){return false}a.remove();delete this.pictures[b]},effect:function(b,e,c){var a=this;var d=RPGJS.Effect.New(this.scene,this.map);this.scrolling.freeze=true;function f(){a.scrolling.freeze=false;if(c){c()}}e.push(f);d[b].apply(d,e)},scrollMap:function(c,b){var a=this;this.scrolling.freeze=true;RPGJS.Timeline.New(this.map).to({x:-c.x,y:-c.y},120).call(function(){a.scrolling.freeze=false;if(b){b()}})},refreshCharacter:function(b,a){this.getEvent(b).refresh(a)},removeCharacter:function(a){this.getEvent(a).remove();delete this.events[a]},moveEvent:function(d,c,a){var b=a=="left"||a=="right"?"x":"y";this.getEvent(d).move(b,c[b],a);this.layer[3].children().sort(function(f,e){var h=f._z?f._z:f.y;var g=e._z?e._z:e.y;return h-g})},stopEvent:function(a){this.getEvent(a).stop()},getEvent:function(a){if(a==0){return this.player}return this.events[a]},scrollingUpdate:function(){this.scrolling.update()},getWidthPixel:function(){return this.width*this.tile_w},getHeightPixel:function(){return this.height*this.tile_h}});Class.create("Sprite_Character",{el:null,scene:null,old_direction:"",direction:"bottom",initial_dir:null,width:0,height:0,initialize:function(d,c,b,a){this.scene=d;this.entity=Class.New("Entity",[d.getStage(),{},false]);this.entity.setModel(a);this.refresh(c);this.setPosition(this.x,this.y);b.append(this.entity.el)},remove:function(){this.entity.el.remove()},refresh:function(d){var a=this;if(d){for(var b in d){this[b]=d[b]}this.graphic_params=this.graphic_params||{};for(var b in this.graphic_params){this[b]=this.graphic_params[b]!=""?this.graphic_params[b]:this[b]}}if(this.regY){this.regY=+this.regY}if(this.regX){this.regX=+this.regX}if(!this.exist){return}if(!this.initial_dir){this.initial_dir=this.direction}if(this.graphic){function c(){var e=RPGJS.Materials.get("characters_"+a.graphic);a.width=e.width/a.nbSequenceX;a.height=e.height/a.nbSequenceY;a.entity.el.drawImage("characters_"+a.graphic,0,0,a.width,a.height,-a.regX,-a.regY,a.width,a.height);a.setAnimation();a.setSpritesheet();a.stop();if(a.stop_animation){a.startMove()}}if(this.id!=0){RPGJS_Core.Path.loadMaterial("characters",this.graphic,c)}else{c()}}else{this.stop();this.entity.el.removeCmd("drawImage")}this.entity.el.regX=this.regX;this.entity.el.regY=this.regY},getSprite:function(){return this.entity.el},setSpritesheet:function(){var d=[],c;for(var b=0;b<this.nbSequenceY;b++){for(var a=0;a<this.nbSequenceX;a++){c="";if(a==0){switch(b){case 0:c="bottom";break;case 1:c="left";break;case 2:c="right";break;case 3:c="up";break}}d.push(c)}}this.spritesheet=RPGJS.Spritesheet.New("characters_"+this.graphic,{grid:[{size:[this.nbSequenceX,this.nbSequenceY],tile:[this.width,this.height],set:d,reg:[0+this.regX,18+this.regY]}]})},setAnimation:function(){var c=this.nbSequenceX-1,b=this.nbSequenceY-1;var d=Math.abs(-18+(this.speed*3));var a={left:0-this.regX,top:-18-this.regY};this.animation=RPGJS.Animation.New({images:"characters_"+this.graphic,animations:{bottom:{frames:[0,c],size:{width:this.width,height:this.height},position:a,frequence:d},left:{frames:[c+1,c*2+1],size:{width:this.width,height:this.height},position:a,frequence:d},right:{frames:[c*2+2,c*3+2],size:{width:this.width,height:this.height},position:a,frequence:d},up:{frames:[c*3+3,c*4+3],size:{width:this.width,height:this.height},position:a,frequence:d}}});this.animation.add(this.entity.el)},initAnimationActions:function(d){var k,h,f,e,c,l=this;function g(){l.stop()}var b;for(var a in d){b=d[a];k=this.nbSequenceX-1,h=this.nbSequenceY-1;f=b.speed;e={left:0-this.regX,top:-18-this.regY};c={};c[a+"_bottom"]={frames:[0,k],size:{width:this.width,height:this.height},position:e,frequence:f,finish:g};c[a+"_left"]={frames:[k+1,k*2+1],size:{width:this.width,height:this.height},position:e,frequence:f,finish:g};c[a+"_right"]={frames:[k*2+2,k*3+2],size:{width:this.width,height:this.height},position:e,frequence:f,finish:g};c[a+"_up"]={frames:[k*3+3,k*4+3],size:{width:this.width,height:this.height},position:e,frequence:f,finish:g};this.action_animation=RPGJS.Animation.New({images:"characters_"+b.graphic,animations:c});this.action_animation.add(this.entity.el)}},playAnimationAction:function(a){this.action_animation.play(a+"_"+this.getDisplayDirection(),"stop")},setPosition:function(a,b){this.entity.position(a,b)},jumpCharacter:function(a,h,g,f){this.jumping=true;var e=Math.sqrt(a*a+h*h),b=this;this.stop();var c=1,d=function(){var k=b.speed*4;if((a!=0&&Math.abs(a)/k)<c||(h!=0&&Math.abs(h)/k)){b.getSprite().off("canvas:render",d);b.jumping=false;b.startMove();if(f){f()}}else{if(a!=0){b.entity.el.x+=a<0?-k:k}if(h!=0){b.entity.el.y+=h<0?-k:k}}c++};this.getSprite().on("canvas:render",d)},stop:function(){if(!this.animation){return}this.animation.stop();this.spritesheet.draw(this.entity.el,this.getDisplayDirection())},startMove:function(){if(!this.animation){return}this.animation.play(this.getDisplayDirection(),"loop")},move:function(b,c,a){if(this.jumping){return}this.direction=a;this.changeDirection(a);this.entity.el[b]=c},changeDirection:function(c,a){var b=this.getDisplayDirection();if(this.spritesheet&&this.direction!=this.old_direction&&this.graphic){this.spritesheet.draw(this.entity.el,b);if(!this.no_animation){this.animation.play(b,"loop")}this.old_direction=this.direction}},getDisplayDirection:function(){return this.direction_fix?this.initial_dir:this.direction}}).extend("Sprite");